name: Remote Desktop for Video Generation
# ‚ö†Ô∏è EDUCATIONAL USE ONLY - For testing and development purposes

on:
  workflow_dispatch:
    inputs:
      vnc_password:
        description: 'VNC Password (min 6 chars)'
        required: true
        default: 'tubegen123'
      session_hours:
        description: 'Session duration (max 6)'
        required: true
        default: '5'

jobs:
  remote-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max

    steps:
      - name: üì¶ Checkout TubeGen Repository
        uses: actions/checkout@v4

      - name: üñ•Ô∏è Install Desktop Environment (XFCE)
        run: |
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies dbus-x11
          sudo apt-get install -y x11vnc xvfb novnc websockify
          echo "‚úÖ Desktop environment installed"

      - name: üåê Install Chrome & Dependencies
        run: |
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
          rm google-chrome-stable_current_amd64.deb
          echo "‚úÖ Google Chrome installed"

      - name: üì¶ Install Node.js & Project Dependencies
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: üì¶ Install TubeGen Dependencies
        run: |
          npm install
          cd server && npm install && cd ..
          echo "‚úÖ TubeGen dependencies installed"

      - name: üîß Start Virtual Display & VNC
        run: |
          # Create VNC password file
          mkdir -p ~/.vnc
          x11vnc -storepasswd "${{ github.event.inputs.vnc_password }}" ~/.vnc/passwd
          
          # Start virtual display
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2
          
          # Start XFCE desktop
          DISPLAY=:99 startxfce4 &
          sleep 3
          
          # Start VNC server
          x11vnc -display :99 -rfbauth ~/.vnc/passwd -forever -shared -bg -rfbport 5900
          
          echo "‚úÖ VNC server started on display :99, port 5900"

      - name: üåç Setup noVNC (Browser Access)
        run: |
          # Start noVNC websocket proxy
          websockify --web=/usr/share/novnc/ 6080 localhost:5900 &
          sleep 2
          echo "‚úÖ noVNC proxy started on port 6080"

      - name: üöÄ Start TubeGen Backend Server
        run: |
          cd server
          node index.js &
          sleep 3
          echo "‚úÖ TubeGen Director Agent running on port 3001"

      - name: üîó Setup Cloudflare Tunnel (Reliable & Free)
        run: |
          # Download cloudflared
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          rm cloudflared-linux-amd64.deb
          
          # Start Cloudflare Quick Tunnel for noVNC (port 6080)
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          # Wait for tunnel to be ready
          sleep 10
          
          # Extract and display the URL
          TUNNEL_URL=$(grep -oE 'https://[a-z0-9-]+\.trycloudflare\.com' tunnel.log | head -1)
          
          echo ""
          echo "=============================================="
          echo "üñ•Ô∏è  REMOTE DESKTOP CONNECTION INFO"
          echo "=============================================="
          echo ""
          echo "üìå noVNC URL: $TUNNEL_URL"
          echo ""
          echo "üîë Password: ${{ github.event.inputs.vnc_password }}"
          echo ""
          echo "‚è±Ô∏è Session: ${{ github.event.inputs.session_hours }} hours"
          echo "=============================================="
          echo ""
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV
          
          # Also show the log for debugging
          echo "Full tunnel log:"
          cat tunnel.log

      - name: üìã Display Connection Instructions
        run: |
          echo ""
          echo "=============================================="
          echo "üìñ HOW TO CONNECT:"
          echo "=============================================="
          echo ""
          echo "1. Open the noVNC URL above in your browser"
          echo "2. Click 'Connect'"
          echo "3. Enter password: ${{ github.event.inputs.vnc_password }}"
          echo "4. You now have a full Linux desktop!"
          echo ""
          echo "üé¨ TO GENERATE VIDEOS:"
          echo "5. Open Chrome (in Applications menu)"
          echo "6. Go to meta.ai and log in"
          echo "7. Open Terminal (Applications > Terminal)"
          echo "8. Run: cd /home/runner/work/*/*"
          echo "9. Run: npm run dev"
          echo "10. Open http://localhost:5173 in Chrome"
          echo "11. Use the Consultant to generate videos!"
          echo ""
          echo "=============================================="

      - name: ‚è≥ Keep Session Alive
        run: |
          HOURS=${{ github.event.inputs.session_hours }}
          
          echo "üü¢ Session active for $HOURS hours..."
          echo "üìå Connection URL: $TUNNEL_URL"
          echo ""
          echo "Do NOT close this workflow tab!"
          echo ""
          
          # Show hourly updates
          for i in $(seq 1 $HOURS); do
            echo "‚è∞ Hour $i of $HOURS - Session active..."
            sleep 3600
          done
          
          echo "‚úÖ Session ended after $HOURS hours"

      - name: üì§ Upload Generated Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-videos
          path: |
            server/public/scenes/**/*.mp4
            server/output/**/*.mp4
          if-no-files-found: ignore
