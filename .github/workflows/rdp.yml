name: Remote Desktop for Video Generation
# ‚ö†Ô∏è EDUCATIONAL USE ONLY - For testing and development purposes

on:
  workflow_dispatch:
    inputs:
      vnc_password:
        description: 'VNC Password (min 6 chars)'
        required: true
        default: 'tubegen123'
      session_hours:
        description: 'Session duration (max 6)'
        required: true
        default: '5'

jobs:
  remote-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max

    steps:
      - name: üì¶ Checkout TubeGen Repository
        uses: actions/checkout@v4

      - name: üñ•Ô∏è Install Desktop Environment (XFCE)
        run: |
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies dbus-x11
          sudo apt-get install -y x11vnc xvfb novnc websockify
          echo "‚úÖ Desktop environment installed"

      - name: üåê Install Chrome & Dependencies
        run: |
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
          rm google-chrome-stable_current_amd64.deb
          echo "‚úÖ Google Chrome installed"

      - name: üì¶ Install Node.js & Project Dependencies
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: üì¶ Install TubeGen Dependencies
        run: |
          npm install
          cd server && npm install && cd ..
          echo "‚úÖ TubeGen dependencies installed"

      - name: üîß Configure VNC Server
        run: |
          # Create VNC password file
          mkdir -p ~/.vnc
          x11vnc -storepasswd "${{ github.event.inputs.vnc_password }}" ~/.vnc/passwd
          
          # Start virtual display
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2
          
          # Start XFCE desktop
          startxfce4 &
          sleep 3
          
          # Start VNC server
          x11vnc -display :99 -rfbauth ~/.vnc/passwd -forever -shared -bg
          
          echo "‚úÖ VNC server started on display :99"

      - name: üåç Setup noVNC (Browser Access)
        run: |
          # Start noVNC websocket proxy
          websockify --web=/usr/share/novnc/ 6080 localhost:5900 &
          sleep 2
          echo "‚úÖ noVNC proxy started on port 6080"

      - name: üöÄ Start TubeGen Backend Server
        run: |
          cd server
          node index.js &
          sleep 3
          echo "‚úÖ TubeGen Director Agent running on port 3001"

      - name: üîó Setup Tunnel (ngrok/localtunnel)
        run: |
          # Install localtunnel (free, no account needed)
          npm install -g localtunnel
          
          # Start tunnel for noVNC (port 6080)
          npx localtunnel --port 6080 --subdomain tubegen-rdp-${{ github.run_id }} > tunnel.log 2>&1 &
          sleep 5
          
          # Extract URL
          TUNNEL_URL=$(cat tunnel.log | grep -oP 'your url is: \K.*' || echo "Check logs for URL")
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV
          
          echo "=============================================="
          echo "üñ•Ô∏è  REMOTE DESKTOP CONNECTION INFO"
          echo "=============================================="
          echo ""
          echo "üìå noVNC URL (Browser): Check tunnel.log for URL"
          echo "üîë Password: ${{ github.event.inputs.vnc_password }}"
          echo ""
          echo "‚è±Ô∏è Session will run for ${{ github.event.inputs.session_hours }} hours"
          echo "=============================================="

      - name: üìã Display Connection Instructions
        run: |
          echo ""
          echo "=============================================="
          echo "üìñ HOW TO CONNECT:"
          echo "=============================================="
          echo ""
          echo "1. Open the noVNC URL in your browser"
          echo "2. Click 'Connect'"
          echo "3. Enter password: ${{ github.event.inputs.vnc_password }}"
          echo "4. You now have a full Linux desktop!"
          echo ""
          echo "üé¨ TO GENERATE VIDEOS:"
          echo "5. Open Chrome (already installed)"
          echo "6. Go to meta.ai and log in"
          echo "7. Open Terminal and run:"
          echo "   cd /home/runner/work/*/tubegen-mvp"
          echo "   npm run dev"
          echo "8. Open localhost:5173 in Chrome"
          echo "9. Use the Consultant to generate videos!"
          echo ""
          echo "=============================================="
          
          # Show tunnel log
          echo "Tunnel Log:"
          cat tunnel.log || echo "Tunnel starting..."

      - name: ‚è≥ Keep Session Alive
        run: |
          # Keep the session alive for specified hours
          HOURS=${{ github.event.inputs.session_hours }}
          SECONDS_TO_WAIT=$((HOURS * 3600))
          
          echo "Session will remain active for $HOURS hours..."
          echo "Connection info above. Do NOT close this workflow."
          
          # Heartbeat loop
          for i in $(seq 1 $HOURS); do
            echo "‚è∞ Hour $i of $HOURS - Session still active..."
            sleep 3600
          done
          
          echo "‚úÖ Session ended after $HOURS hours"

      - name: üì§ Upload Generated Videos (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-videos
          path: |
            server/public/scenes/**/*.mp4
            server/output/**/*.mp4
          if-no-files-found: ignore
