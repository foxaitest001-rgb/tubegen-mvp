name: Remote Video Generation Server
# This workflow runs a headless video generation server on GitHub Actions
# Your local TubeGen app will send requests to this server for video generation

on:
  workflow_dispatch:
    inputs:
      session_hours:
        description: 'Session duration (max 6)'
        required: true
        default: '5'

jobs:
  video-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4

      - name: üåê Install Chrome
        run: |
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
          rm google-chrome-stable_current_amd64.deb
          sudo apt-get install -y xvfb
          echo "‚úÖ Chrome installed"

      - name: üì¶ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install Server Dependencies
        run: |
          cd server
          npm install
          echo "‚úÖ Server dependencies installed"

      - name: üîß Start Virtual Display
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2
          echo "DISPLAY=:99" >> $GITHUB_ENV
          echo "‚úÖ Virtual display started"

      - name: üöÄ Start Video Generation Server
        run: |
          cd server
          export DISPLAY=:99
          
          # Start the server with CORS enabled for remote access
          node index.js &
          sleep 5
          
          # Verify server is running
          curl -s http://localhost:3001/health || echo "Health endpoint not available"
          echo "‚úÖ Video generation server running on port 3001"

      - name: üîó Setup Cloudflare Tunnel for API
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          rm cloudflared-linux-amd64.deb
          
          # Tunnel the server API (port 3001)
          cloudflared tunnel --url http://localhost:3001 > /tmp/tunnel.log 2>&1 &
          sleep 10
          
          # Extract URL
          API_URL=$(grep -oE 'https://[a-z0-9-]+\.trycloudflare\.com' /tmp/tunnel.log | head -1)
          
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë           üé¨  REMOTE VIDEO GENERATION SERVER READY!                      ‚ïë"
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë                                                                          ‚ïë"
          echo "‚ïë  üìå REMOTE API URL:                                                      ‚ïë"
          echo "‚ïë                                                                          ‚ïë"
          echo "‚ïë     $API_URL"
          echo "‚ïë                                                                          ‚ïë"
          echo "‚ïë  ‚è±Ô∏è  Session: ${{ github.event.inputs.session_hours }} hours                                                   ‚ïë"
          echo "‚ïë                                                                          ‚ïë"
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë                                                                          ‚ïë"
          echo "‚ïë  üîß HOW TO USE:                                                          ‚ïë"
          echo "‚ïë                                                                          ‚ïë"
          echo "‚ïë  1. Copy the API URL above                                               ‚ïë"
          echo "‚ïë                                                                          ‚ïë"
          echo "‚ïë  2. In your LOCAL TubeGen app, Click on 'Model Selectors'                ‚ïë"
          echo "‚ïë                                                                          ‚ïë"  
          echo "‚ïë  3. Paste the API URL in 'Remote Server URL' field                       ‚ïë"
          echo "‚ïë                                                                          ‚ïë"
          echo "‚ïë  4. Use Consultant ‚Üí Generate Videos ‚Üí They run on THIS server!         ‚ïë"
          echo "‚ïë                                                                          ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          echo ""
          echo "API_URL=$API_URL" >> $GITHUB_ENV

      - name: ‚è≥ Keep Server Alive
        run: |
          HOURS=${{ github.event.inputs.session_hours }}
          
          echo "üü¢ Server active for $HOURS hours..."
          echo "üìå API URL: $API_URL"
          echo ""
          echo "Waiting for video generation requests..."
          echo ""
          
          # Monitor server logs
          tail -f /tmp/server.log 2>/dev/null &
          
          for i in $(seq 1 $HOURS); do
            echo "‚è∞ Hour $i of $HOURS - Server running..."
            sleep 3600
          done
          
          echo "‚úÖ Session ended"

      - name: üì§ Upload Generated Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-videos-${{ github.run_id }}
          path: |
            ${{ github.workspace }}/server/public/scenes/**/*.mp4
            ${{ github.workspace }}/server/output/**/*.mp4
          if-no-files-found: ignore
          retention-days: 7
