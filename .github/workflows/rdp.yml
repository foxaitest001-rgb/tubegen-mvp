name: Remote Desktop for Video Generation
# âš ï¸ EDUCATIONAL USE ONLY - For testing and development purposes

on:
  workflow_dispatch:
    inputs:
      vnc_password:
        description: 'VNC Password (min 6 chars)'
        required: true
        default: 'tubegen123'
      session_hours:
        description: 'Session duration (max 6)'
        required: true
        default: '5'

env:
  PROJECT_DIR: ${{ github.workspace }}

jobs:
  remote-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max

    steps:
      - name: ğŸ“¦ Checkout TubeGen Repository
        uses: actions/checkout@v4

      - name: ğŸ–¥ï¸ Install Desktop Environment (XFCE)
        run: |
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies dbus-x11 xterm
          sudo apt-get install -y x11vnc xvfb novnc websockify
          echo "âœ… Desktop environment installed"

      - name: ğŸŒ Install Chrome & Dependencies
        run: |
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
          rm google-chrome-stable_current_amd64.deb
          echo "âœ… Google Chrome installed"

      - name: ğŸ“¦ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“¦ Install Project Dependencies
        run: |
          cd $PROJECT_DIR
          npm install
          cd server && npm install && cd ..
          echo "âœ… All dependencies installed"
          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV

      - name: ğŸ”§ Start Virtual Display & VNC
        run: |
          # Start virtual display
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2
          
          # Create VNC password file
          mkdir -p ~/.vnc
          x11vnc -storepasswd "${{ github.event.inputs.vnc_password }}" ~/.vnc/passwd
          
          # Start XFCE desktop
          DISPLAY=:99 startxfce4 &
          sleep 5
          
          # Start VNC server
          x11vnc -display :99 -rfbauth ~/.vnc/passwd -forever -shared -bg -rfbport 5900
          
          echo "âœ… VNC server started on display :99, port 5900"

      - name: ğŸŒ Setup noVNC (Browser Access)
        run: |
          websockify --web=/usr/share/novnc/ 6080 localhost:5900 &
          sleep 2
          echo "âœ… noVNC proxy started on port 6080"

      - name: ğŸš€ Start TubeGen Services (Auto)
        run: |
          export DISPLAY=:99
          cd $PROJECT_DIR
          
          # Start backend server
          cd server
          node index.js > /tmp/server.log 2>&1 &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          cd ..
          
          sleep 3
          
          # Start frontend dev server
          npm run dev > /tmp/frontend.log 2>&1 &
          FRONTEND_PID=$!
          echo "FRONTEND_PID=$FRONTEND_PID" >> $GITHUB_ENV
          
          sleep 5
          
          echo "âœ… Backend running (PID: $SERVER_PID)"
          echo "âœ… Frontend running (PID: $FRONTEND_PID)"
          echo ""
          echo "ğŸ“ Project directory: $PROJECT_DIR"

      - name: ğŸŒ Open Chrome with TubeGen & Meta.ai
        run: |
          export DISPLAY=:99
          
          # Open Chrome with TubeGen app and Meta.ai tabs
          google-chrome --no-sandbox --disable-gpu \
            --user-data-dir=/tmp/chrome-profile \
            http://localhost:5173 \
            https://meta.ai &
          
          sleep 5
          echo "âœ… Chrome opened with TubeGen and Meta.ai"

      - name: ğŸ”— Setup Cloudflare Tunnel
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          rm cloudflared-linux-amd64.deb
          
          # Start tunnel for noVNC
          cloudflared tunnel --url http://localhost:6080 > /tmp/tunnel.log 2>&1 &
          sleep 10
          
          # Extract URL
          TUNNEL_URL=$(grep -oE 'https://[a-z0-9-]+\.trycloudflare\.com' /tmp/tunnel.log | head -1)
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           ğŸ–¥ï¸  REMOTE DESKTOP READY!                          â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                              â•‘"
          echo "â•‘  ğŸ“Œ VNC URL: ${TUNNEL_URL}/vnc.html                          â•‘"
          echo "â•‘                                                              â•‘"
          echo "â•‘  ğŸ”‘ Password: ${{ github.event.inputs.vnc_password }}                                     â•‘"
          echo "â•‘                                                              â•‘"
          echo "â•‘  â±ï¸  Session: ${{ github.event.inputs.session_hours }} hours                                            â•‘"
          echo "â•‘                                                              â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  âœ… Chrome is ALREADY open with:                             â•‘"
          echo "â•‘     â€¢ TubeGen App (localhost:5173)                           â•‘"
          echo "â•‘     â€¢ Meta.ai (log in to enable video generation)            â•‘"
          echo "â•‘                                                              â•‘"
          echo "â•‘  ğŸ¬ TO GENERATE VIDEOS:                                      â•‘"
          echo "â•‘     1. Connect to VNC URL above                              â•‘"
          echo "â•‘     2. Log into Meta.ai in the Chrome tab                    â•‘"
          echo "â•‘     3. Switch to TubeGen tab                                 â•‘"
          echo "â•‘     4. Use Consultant â†’ 'send to director'                   â•‘"
          echo "â•‘     5. Videos generate automatically!                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "TUNNEL_URL=${TUNNEL_URL}/vnc.html" >> $GITHUB_ENV

      - name: â³ Keep Session Alive
        run: |
          HOURS=${{ github.event.inputs.session_hours }}
          
          echo "ğŸŸ¢ Session active for $HOURS hours..."
          echo "ğŸ“Œ VNC URL: $TUNNEL_URL"
          echo ""
          
          # Create a helper script for the user
          cat > /tmp/tubegen-help.sh << 'EOF'
          echo "=== TubeGen Quick Commands ==="
          echo "cd $PROJECT_DIR           # Go to project"
          echo "cat /tmp/server.log       # View server logs"
          echo "cat /tmp/frontend.log     # View frontend logs"
          echo "cat /tmp/tunnel.log       # View tunnel logs"
          EOF
          chmod +x /tmp/tubegen-help.sh
          
          # Hourly status updates
          for i in $(seq 1 $HOURS); do
            echo "â° Hour $i of $HOURS - Services running..."
            echo "   Server PID: $SERVER_PID | Frontend PID: $FRONTEND_PID"
            sleep 3600
          done
          
          echo "âœ… Session ended after $HOURS hours"

      - name: ğŸ“¤ Upload Generated Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-videos-${{ github.run_id }}
          path: |
            ${{ github.workspace }}/server/public/scenes/**/*.mp4
            ${{ github.workspace }}/server/output/**/*.mp4
            ${{ github.workspace }}/output/**/*.mp4
          if-no-files-found: ignore
          retention-days: 7
