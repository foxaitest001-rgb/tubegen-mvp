name: Remote Video Generation (Hybrid)
# Combines VNC desktop (for Meta.ai login) + API tunnel (for remote video generation)

on:
  workflow_dispatch:
    inputs:
      vnc_password:
        description: 'VNC Password (min 6 chars)'
        required: true
        default: 'tubegen123'
      session_hours:
        description: 'Session duration (max 6)'
        required: true
        default: '5'

env:
  PROJECT_DIR: ${{ github.workspace }}

jobs:
  video-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ–¥ï¸ Install Desktop & VNC
        run: |
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies dbus-x11 xterm
          sudo apt-get install -y x11vnc xvfb novnc websockify
          echo "âœ… Desktop environment installed"

      - name: ðŸŒ Install Chrome
        run: |
          wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
          rm google-chrome-stable_current_amd64.deb
          echo "âœ… Chrome installed"

      - name: ðŸŽ¬ Install FFmpeg
        run: |
          sudo apt-get install -y ffmpeg
          ffmpeg -version | head -1
          echo "âœ… FFmpeg installed for video assembly"

      - name: ðŸ—£ï¸ Install Piper TTS (Linux x64)
        run: |
          mkdir -p server/piper
          wget -q -O piper.tar.gz https://github.com/rhasspy/piper/releases/download/2023.11.14-2/piper_linux_x86_64.tar.gz
          tar -xvf piper.tar.gz -C server/piper --strip-components=1
          rm piper.tar.gz
          chmod +x server/piper/piper
          echo "âœ… Piper TTS installed in server/piper"

      - name: ðŸŽ¤ Download Voice Models
        run: |
          mkdir -p public/piper
          cd public/piper
          # Ryan (Male - Medium Quality)
          wget -q -O en_US-ryan-medium.onnx https://huggingface.co/rhasspy/piper-voices/resolve/main/en/en_US/ryan/medium/en_US-ryan-medium.onnx
          wget -q -O en_US-ryan-medium.onnx.json https://huggingface.co/rhasspy/piper-voices/resolve/main/en/en_US/ryan/medium/en_US-ryan-medium.onnx.json
          # Lessac (Female - Medium Quality)
          wget -q -O en_US-lessac-medium.onnx https://huggingface.co/rhasspy/piper-voices/resolve/main/en/en_US/lessac/medium/en_US-lessac-medium.onnx
          wget -q -O en_US-lessac-medium.onnx.json https://huggingface.co/rhasspy/piper-voices/resolve/main/en/en_US/lessac/medium/en_US-lessac-medium.onnx.json
          # Joe (Male - Medium Quality)
          wget -q -O en_US-joe-medium.onnx https://huggingface.co/rhasspy/piper-voices/resolve/main/en/en_US/joe/medium/en_US-joe-medium.onnx
          wget -q -O en_US-joe-medium.onnx.json https://huggingface.co/rhasspy/piper-voices/resolve/main/en/en_US/joe/medium/en_US-joe-medium.onnx.json
          ls -la
          echo "âœ… Voice models downloaded to public/piper"

      - name: ðŸ“¦ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ðŸ“¦ Install Server Dependencies
        run: |
          cd server && npm install && cd ..
          echo "âœ… Server dependencies installed"

      - name: ðŸ”§ Start Virtual Display & VNC
        run: |
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 &
          sleep 2
          
          mkdir -p ~/.vnc
          x11vnc -storepasswd "${{ github.event.inputs.vnc_password }}" ~/.vnc/passwd
          
          DISPLAY=:99 startxfce4 &
          sleep 5
          
          x11vnc -display :99 -rfbauth ~/.vnc/passwd -forever -shared -bg -rfbport 5900
          websockify --web=/usr/share/novnc/ 6080 localhost:5900 &
          sleep 2
          
          echo "âœ… VNC ready on port 6080"

      - name: ðŸŒ Open Chrome with Meta.ai (Debug Port Enabled)
        run: |
          export DISPLAY=:99
          
          # Launch Chrome with remote debugging port so Director can connect to it
          google-chrome \
            --no-sandbox \
            --disable-gpu \
            --user-data-dir=/tmp/chrome-profile \
            --remote-debugging-port=9222 \
            https://meta.ai &
          
          sleep 5
          echo "âœ… Chrome opened with Meta.ai (Debug port: 9222)"
          echo "   Director will connect to this browser session"

      - name: ðŸš€ Start Video Generation Server
        run: |
          export DISPLAY=:99
          cd server
          node index.js > /tmp/server.log 2>&1 &
          sleep 3
          echo "âœ… Director Agent running on port 3001"

      - name: ðŸ”— Setup Cloudflare Tunnels
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          rm cloudflared-linux-amd64.deb
          
          # Tunnel 1: VNC (for login)
          cloudflared tunnel --url http://localhost:6080 > /tmp/vnc_tunnel.log 2>&1 &
          
          # Tunnel 2: API (for video generation)
          cloudflared tunnel --url http://localhost:3001 > /tmp/api_tunnel.log 2>&1 &
          
          # Wait for VNC tunnel URL (retry up to 30 seconds)
          VNC_URL=""
          for i in $(seq 1 15); do
            VNC_URL=$(grep -oE 'https://[a-z0-9-]+\.trycloudflare\.com' /tmp/vnc_tunnel.log 2>/dev/null | head -1)
            if [ -n "$VNC_URL" ]; then break; fi
            echo "â³ Waiting for VNC tunnel... (attempt $i/15)"
            sleep 2
          done
          
          # Wait for API tunnel URL (retry up to 30 seconds)
          API_URL=""
          for i in $(seq 1 15); do
            API_URL=$(grep -oE 'https://[a-z0-9-]+\.trycloudflare\.com' /tmp/api_tunnel.log 2>/dev/null | head -1)
            if [ -n "$API_URL" ]; then break; fi
            echo "â³ Waiting for API tunnel... (attempt $i/15)"
            sleep 2
          done
          
          # Warn if either tunnel failed
          if [ -z "$VNC_URL" ]; then
            echo "âš ï¸ WARNING: VNC tunnel URL not found! Check /tmp/vnc_tunnel.log"
            cat /tmp/vnc_tunnel.log
          fi
          if [ -z "$API_URL" ]; then
            echo "âš ï¸ WARNING: API tunnel URL not found! Check /tmp/api_tunnel.log"
            cat /tmp/api_tunnel.log
          fi
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           ðŸŽ¬  REMOTE VIDEO GENERATION SERVER READY!                           â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                               â•‘"
          echo "â•‘  ðŸ“º VNC URL (for login):                                                      â•‘"
          echo "â•‘     ${VNC_URL}/vnc.html                                                       â•‘"
          echo "â•‘     Password: ${{ github.event.inputs.vnc_password }}                         â•‘"
          echo "â•‘                                                                               â•‘"
          echo "â•‘  ðŸ”Œ API URL (paste in TubeGen):                                               â•‘"
          echo "â•‘     ${API_URL}                                                                â•‘"
          echo "â•‘                                                                               â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                                               â•‘"
          echo "â•‘  ðŸ“‹ STEPS:                                                                    â•‘"
          echo "â•‘     1. Open VNC URL â†’ Log into Meta.ai in Chrome                              â•‘"
          echo "â•‘     2. Copy API URL â†’ Paste in TubeGen 'Remote Server URL'                    â•‘"
          echo "â•‘     3. Use Consultant â†’ Videos generate on this server!                       â•‘"
          echo "â•‘                                                                               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          echo "VNC_URL=${VNC_URL}/vnc.html" >> $GITHUB_ENV
          echo "API_URL=${API_URL}" >> $GITHUB_ENV

      - name: â³ Keep Server Alive & Show Logs
        run: |
          HOURS=${{ github.event.inputs.session_hours }}
          
          echo "ðŸŸ¢ Server active for $HOURS hours"
          echo "ðŸ“º VNC: $VNC_URL"
          echo "ðŸ”Œ API: $API_URL"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â• SERVER LOG â•â•â•â•â•â•â•â•â•â•â•"
          
          # Show server logs in real-time
          tail -f /tmp/server.log &
          TAIL_PID=$!
          
          for i in $(seq 1 $HOURS); do
            sleep 3600
            echo ""
            echo "â° Hour $i of $HOURS completed"
          done
          
          kill $TAIL_PID 2>/dev/null || true
          echo "âœ… Session ended"

      - name: ðŸ“¤ Upload Generated Videos & Voiceovers
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-content-${{ github.run_id }}
          path: |
            ${{ github.workspace }}/public/output/**/*
            ${{ github.workspace }}/server/output/**/*
          if-no-files-found: warn
          retention-days: 7
